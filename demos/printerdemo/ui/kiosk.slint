// Copyright Â© SixtyFPS GmbH <info@slint.dev>
// SPDX-License-Identifier: MIT

import { PrinterState, Page, SubPage, PrinterData } from "common.slint";
import { PrinterQueue } from "./pages/printer_queue.slint";
import { PrinterSettings } from "./pages/pages.slint";

export enum KioskStep {
    Home,
    HomePrint,
    HomePrintBack,
    HomeScan,
    HomeScanStart,
    HomeCopy,
    HomeCopyStart,
    HomeUsb,
    HomeUsbStart,
    Ink,
    Settings,
    Theme,
}

export component KioskController {
    in-out property <bool> kiosk-mode: true;
    in-out property <duration> inactivity-timeout: 30s;

    property <KioskStep> kiosk-step: KioskStep.Home;

    property <int> scan-sequence-step: 0;
    property <bool> scan-sequence-running: false;
    property <int> copy-sequence-step: 0;
    property <bool> copy-sequence-running: false;
    property <int> usb-sequence-step: 0;
    property <bool> usb-sequence-running: false;
    property <int> settings-sequence-step: 0;
    property <bool> settings-sequence-running: false;

    function stop-all-sequences() {
        scan-sequence-running = false;
        copy-sequence-running = false;
        usb-sequence-running = false;
        settings-sequence-running = false;
    }

    function start-scan-sequence() {
        scan-sequence-step = 0;
        scan-sequence-running = true;
    }

    function start-copy-sequence() {
        copy-sequence-step = 0;
        copy-sequence-running = true;
    }

    function start-usb-sequence() {
        usb-sequence-step = 0;
        usb-sequence-running = true;
    }

    function start-settings-sequence() {
        settings-sequence-step = 0;
        settings-sequence-running = true;
    }

    function advance-kiosk() {
        if (kiosk-step == KioskStep.Home) {
            PrinterState.active-page = Page.home;
            PrinterState.active-subpage = SubPage.none;
            kiosk-step = KioskStep.HomePrint;
            kiosk-timer.interval = 3s;

        } else if (kiosk-step == KioskStep.HomePrint) {
            PrinterState.active-page = Page.home;
            PrinterState.active-subpage = SubPage.print;
            kiosk-step = KioskStep.HomePrintBack;
            kiosk-timer.interval = 3s;

        } else if (kiosk-step == KioskStep.HomePrintBack) {
            PrinterState.active-subpage = SubPage.none;
            kiosk-step = KioskStep.HomeScan;
            kiosk-timer.interval = 2s;

        } else if (kiosk-step == KioskStep.HomeScan) {
            PrinterState.active-subpage = SubPage.scan;
            start-scan-sequence();
            kiosk-step = KioskStep.HomeScanStart;
            kiosk-timer.interval = 7s;

        } else if (kiosk-step == KioskStep.HomeScanStart) {
            PrinterQueue.start-job(@tr("Scan"));
            PrinterState.active-subpage = SubPage.none;
            kiosk-step = KioskStep.HomeCopy;
            kiosk-timer.interval = 2s;

        } else if (kiosk-step == KioskStep.HomeCopy) {
            PrinterState.active-subpage = SubPage.copy;
            start-copy-sequence();
            kiosk-step = KioskStep.HomeCopyStart;
            kiosk-timer.interval = 7s;

        } else if (kiosk-step == KioskStep.HomeCopyStart) {
            PrinterQueue.start-job(@tr("Copy"));
            PrinterState.active-subpage = SubPage.none;
            kiosk-step = KioskStep.HomeUsb;
            kiosk-timer.interval = 2s;

        } else if (kiosk-step == KioskStep.HomeUsb) {
            PrinterState.active-subpage = SubPage.usb;
            start-usb-sequence();
            kiosk-step = KioskStep.HomeUsbStart;
            kiosk-timer.interval = 4s;

        } else if (kiosk-step == KioskStep.HomeUsbStart) {
            PrinterQueue.start-job(@tr("USB Print"));
            PrinterState.active-subpage = SubPage.none;
            kiosk-step = KioskStep.Ink;
            kiosk-timer.interval = 4s;

        } else if (kiosk-step == KioskStep.Ink) {
            PrinterState.active-page = Page.ink;
            PrinterState.active-subpage = SubPage.none;
            kiosk-step = KioskStep.Settings;
            kiosk-timer.interval = 4s;

        } else if (kiosk-step == KioskStep.Settings) {
            PrinterState.active-page = Page.settings;
            PrinterState.active-subpage = SubPage.none;
            start-settings-sequence();
            kiosk-step = KioskStep.Theme;
            kiosk-timer.interval = 10s;

        } else {
            PrinterData.current-theme-index = mod(PrinterData.current-theme-index + 1, 4);
            kiosk-step = KioskStep.Home;
            kiosk-timer.interval = 3s;
        }

        debug("Kiosk step:", kiosk-step);
    }

    kiosk-timer := Timer {
        running: kiosk-mode;
        interval: 5s;
        triggered => {
            root.advance-kiosk();
        }
    }

    inactivity-timer := Timer {
        running: !kiosk-mode;
        interval: inactivity-timeout;
        triggered => {
            kiosk-mode = true;
        }
    }

    changed kiosk-mode => {
        if (kiosk-mode) {
            kiosk-step = KioskStep.Home;
            PrinterState.active-page = Page.home;
            PrinterState.active-subpage = SubPage.none;
            kiosk-timer.restart();
        } else {
            stop-all-sequences();
            inactivity-timer.restart();
        }
    }

    scan-sequence-timer := Timer {
        interval: 1s;
        running: scan-sequence-running;
        triggered => {
            if (scan-sequence-step == 0) {
                PrinterData.scan-copies = mod(PrinterData.scan-copies, 100) + 1;
            } else if (scan-sequence-step == 1) {
                PrinterData.scan-is-color = !PrinterData.scan-is-color;
            } else if (scan-sequence-step == 2) {
                PrinterData.scan-quality-index = mod(PrinterData.scan-quality-index + 1, 3);
            } else if (scan-sequence-step == 3) {
                PrinterData.scan-format-index = mod(PrinterData.scan-format-index + 1, 3);
            } else if (scan-sequence-step == 4) {
                PrinterData.scan-paper-size-index = mod(PrinterData.scan-paper-size-index + 1, 2);
            } else if (scan-sequence-step == 5) {
                PrinterData.scan-layout-index = mod(PrinterData.scan-layout-index + 1, 2);
                scan-sequence-running = false;
                return;
            }

            scan-sequence-step += 1;
        }
    }

    copy-sequence-timer := Timer {
        interval: 1s;
        running: copy-sequence-running;
        triggered => {
            if (copy-sequence-step == 0) {
                PrinterData.copy-copies = mod(PrinterData.copy-copies, 100) + 1;
            } else if (copy-sequence-step == 1) {
                PrinterData.copy-is-color = !PrinterData.copy-is-color;
            } else if (copy-sequence-step == 2) {
                PrinterData.copy-quality-index = mod(PrinterData.copy-quality-index + 1, 3);
            } else if (copy-sequence-step == 3) {
                PrinterData.copy-size-index = mod(PrinterData.copy-size-index + 1, 3);
            } else if (copy-sequence-step == 4) {
                PrinterData.copy-paper-size-index = mod(PrinterData.copy-paper-size-index + 1, 2);
            } else if (copy-sequence-step == 5) {
                PrinterData.copy-layout-index = mod(PrinterData.copy-layout-index + 1, 2);
                copy-sequence-running = false;
                return;
            }

            copy-sequence-step += 1;
        }
    }

    usb-sequence-timer := Timer {
        interval: 1s;
        running: usb-sequence-running;
        triggered => {
            if (usb-sequence-step == 0) {
                PrinterData.usb-file-index = mod(PrinterData.usb-file-index + 1, 4);
            } else if (usb-sequence-step == 1) {
                PrinterData.usb-copies = mod(PrinterData.usb-copies, 100) + 1;
            } else if (usb-sequence-step == 2) {
                PrinterData.usb-is-color = !PrinterData.usb-is-color;
                usb-sequence-running = false;
                return;
            }

            usb-sequence-step += 1;
        }
    }

    settings-sequence-timer := Timer {
        interval: 1s;
        running: settings-sequence-running;
        triggered => {
            if (settings-sequence-step == 0) {
                PrinterData.settings-turbo-mode = !PrinterData.settings-turbo-mode;
            } else if (settings-sequence-step == 1) {
                PrinterData.settings-eco-mode = !PrinterData.settings-eco-mode;
            } else if (settings-sequence-step == 2) {
                PrinterData.settings-sort-pages = !PrinterData.settings-sort-pages;
            } else if (settings-sequence-step == 3) {
                PrinterData.settings-layout-index = mod(PrinterData.settings-layout-index + 1, 2);
            } else if (settings-sequence-step == 4) {
                PrinterData.settings-tray-index = mod(PrinterData.settings-tray-index + 1, 3);
            } else if (settings-sequence-step == 5) {
                PrinterData.settings-quality-index = mod(PrinterData.settings-quality-index + 1, 3);
            } else if (settings-sequence-step == 6) {
                PrinterData.settings-language-index = mod(PrinterData.settings-language-index + 1, 2);
                PrinterSettings.change_language(PrinterData.settings-language-index);
            } else if (settings-sequence-step == 7) {
                PrinterData.settings-color-mode-index = mod(PrinterData.settings-color-mode-index + 1, 2);
            } else {
                settings-sequence-running = false;
                return;
            }

            settings-sequence-step += 1;
        }
    }
}
