// Copyright Â© SixtyFPS GmbH <info@slint.dev>
// SPDX-License-Identifier: GPL-3.0-only OR LicenseRef-Slint-Royalty-free-2.0 OR LicenseRef-Slint-Software-3.0

// Open me with the live-preview to see the logged keyboard events
export component TestCase inherits Window {
    in-out property <[keyboard-shortcut]> shortcuts: [
        @keys(Control + Shift + Escape),
        @keys(Control + Shift + A),
        @keys(Control + Plus),
    ];

    // For access from NodeJS
    out property <keyboard-shortcut> first_shortcut: shortcuts[0];

    out property <int> matches: 0;

    Text {
        text: input.has-focus ? "Focused" : "Unfocused";
    }

    init => { input.focus() }

    input := TextInput {
        min-width: 100px;
        min-height: 50px;
        key-pressed(event) => {
            debug("Pressed: ", event);
            EventResult.reject
        }
        key-released(event) => {
            debug("Released: ", event);
            let old-matches = root.matches;

            if root.shortcuts[0].matches(event) { matches += 1; }
            if root.shortcuts[1].matches(event) { matches += 1; }
            if root.shortcuts[2].matches(event) { matches += 1; }

            if old-matches != root.matches {
                debug("MATCHES");
                return EventResult.accept;
            }
            EventResult.reject
        }
    }
}


/*

```cpp
auto handle = TestCase::create();
const TestCase &instance = *handle;

const auto shortcuts = instance.get_shortcuts();
const auto shortcut = shortcuts->row_data(0).value();
slint::SharedString shortcut_string;
slint::cbindgen_private::slint_keyboard_shortcut_to_string(&shortcut, &shortcut_string);
assert_eq(shortcut_string, "Control+Shift+\"\\u{1b}\"");

using namespace slint::platform;

slint::SharedString escape(key_codes::Escape);
slint::SharedString shift(key_codes::Shift);
slint::SharedString control(key_codes::Control);
slint::SharedString alt(key_codes::Alt);

using slint::private_api::testing::send_keyboard_shortcut;

// Does not match with incorrect modifiers
send_keyboard_shortcut(&instance, {escape});
send_keyboard_shortcut(&instance, {control, escape});
send_keyboard_shortcut(&instance, {alt, escape});
send_keyboard_shortcut(&instance, {control, alt, shift, escape});
assert_eq(instance.get_matches(), 0);

// matches with correct modifiers
send_keyboard_shortcut(&instance, {control, shift, escape});
assert_eq(instance.get_matches(), 1);

// additional matches
send_keyboard_shortcut(&instance, { control, "+" });
send_keyboard_shortcut(&instance, { control, shift, "+" });
send_keyboard_shortcut(&instance, { control, shift, "A" });
// A lowercase 'a' together with Shift may appear if caps-lock is active, or on the Qt backend.
send_keyboard_shortcut(&instance, { control, shift, "a" });
assert_eq(instance.get_matches(), 5);

// additional non-matches
send_keyboard_shortcut(&instance, { control, alt, "+" });
send_keyboard_shortcut(&instance, { control, "A" });
send_keyboard_shortcut(&instance, { control, "a" });
assert_eq(instance.get_matches(), 5);
```

```rust
use slint::Model;

let instance = TestCase::new().unwrap();
let shortcuts = instance.get_shortcuts();
let expected = [
    "Control+Shift+\"\\u{1b}\"",
    "Control+Shift+\"a\"",
    "Control+IgnoreShift+\"+\"",
];
for (shortcut, expected) in shortcuts.iter().zip(expected) {
    assert_eq!(shortcut.to_string(), expected);
}

use slint::private_unstable_api::re_exports::Key;
// Doesn't match with incorrect modifiers
slint_testing::send_keyboard_shortcut(&instance, [Key::Escape]);
slint_testing::send_keyboard_shortcut(&instance, [Key::Control, Key::Escape]);
slint_testing::send_keyboard_shortcut(&instance, [Key::Control, Key::Alt, Key::Shift, Key::Escape]);
assert_eq!(instance.get_matches(), 0);
// matches with correct modifers
slint_testing::send_keyboard_shortcut(&instance, [Key::Control, Key::Shift, Key::Escape]);
assert_eq!(instance.get_matches(), 1);

// additional matches
slint_testing::send_keyboard_shortcut(&instance, [Key::Control, Key::Plus]);
slint_testing::send_keyboard_shortcut(&instance, [Key::Control, Key::Shift, Key::Plus]);
slint_testing::send_keyboard_shortcut(&instance, [char::from(Key::Control), char::from(Key::Shift), 'A']);
// A lowercase 'a' together with Shift may appear if caps-lock is active, or on the Qt backend.
slint_testing::send_keyboard_shortcut(&instance, [char::from(Key::Control), char::from(Key::Shift), 'a']);
assert_eq!(instance.get_matches(), 5);

// additional non-matches
slint_testing::send_keyboard_shortcut(&instance, [Key::Control, Key::Alt, Key::Plus]);
slint_testing::send_keyboard_shortcut(&instance, [char::from(Key::Control), 'A']);
slint_testing::send_keyboard_shortcut(&instance, [char::from(Key::Control), 'a']);
assert_eq!(instance.get_matches(), 5);
```

```js
var instance = new slint.TestCase({});

let shortcut = instance.first_shortcut;
assert.equal(shortcut, "Control+Shift+\"\\u{1b}\"")

// TODO: Simulate shortcuts in JS
```

*/
