// Copyright Â© SixtyFPS GmbH <info@slint.dev>
// SPDX-License-Identifier: GPL-3.0-only OR LicenseRef-Slint-Royalty-free-2.0 OR LicenseRef-Slint-Software-3.0

// Test case for issue #7402: Init callback accessing geometry properties
// https://github.com/slint-ui/slint/issues/7402
//
// The problem is that init callbacks may be triggered during layout computation.
// When the callback tries to access geometry properties that depend on the layout
// being evaluated, it can create a circular dependency.
//
// Note: This specific pattern (VerticalLayout + Rectangle + init + absolute-position)
// does not currently panic but returns 0 for geometry properties during init.
// The recursion panic issue is more likely to occur with ComponentContainer.
//
// Only run on Rust interpreter - ComponentFactory not supported in C++/JS
//ignore: cpp,js,pyi

export global TestResults {
    in-out property <length> captured-y: 0px;
}

export component TestCase inherits Window {
    width: 300px;
    height: 300px;

    VerticalLayout {
        Rectangle {
            background: blue;
            height: 50px;
        }
        // ComponentContainer is key to triggering the issue because its layout_info
        // calls ensure_updated() which runs init callbacks during layout evaluation
        container := ComponentContainer {
        }
    }

    in property <component-factory> factory <=> container.component-factory;
    // Test passes if no panic occurs - the actual geometry value isn't verified here
    // because the issue is that accessing geometry in init can cause recursion
    out property <bool> test: true;
}

/*
```rust
// Test that accessing absolute-position in init callback within ComponentContainer
// causes recursion panic - issue #7402
use slint::ComponentHandle;

let factory = slint::ComponentFactory::new(|ctx| {
    let compiler = slint_interpreter::Compiler::new();
    let e = spin_on::spin_on(compiler.build_from_source(
        r#"
export component EmbeddedComponent inherits Rectangle {
    background: red;
    preferred-height: 50px;
    init => {
        // This access to absolute-position during init causes the recursion panic
        // because the layout is being computed when init runs
        debug(self.absolute-position.y);
    }
}
"#.into(),
        std::path::PathBuf::from("embedded.slint"),
    )).component("EmbeddedComponent").unwrap();
    e.create_embedded(ctx).ok()
});

let instance = TestCase::new().unwrap();
// FIXME: This triggers "Recursion detected" panic when the factory is set
// instance.set_factory(factory);
```
*/
