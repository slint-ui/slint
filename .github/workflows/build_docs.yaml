# Copyright © SixtyFPS GmbH <info@slint.dev>
# SPDX-License-Identifier: GPL-3.0-only OR LicenseRef-Slint-Royalty-free-2.0 OR LicenseRef-Slint-Software-3.0

# Build various demo binaries, c++ packages and documentation and publish them on the website
#
# Execution Flow:
# ┌──────────────────────────────────────────────────────────────┐
# │  Jobs 1, 2, 3 run in parallel (no dependencies)              │
# └──────────┬────────────────────┬──────────────────┬───────────┘
#            │                    │                  │
#       ┌────▼────┐               │             ┌────▼────┐
#       │  Job 2  │               │             │  Job 1  │
#       └────┬────┘               │             └────┬────┘
#            │                    │                  │
#       ┌────▼────────┐           │          ┌───────▼─────────┐
#       │   Job 4     │           │          │     Job 5       │
#       │ (Astro +    │           │          │ (Check warnings)│
#       │  Tests)     │           │          └─────────────────┘
#       └────┬────────┘           │
#            │                    │
#            └────────┬───────────┴──────────┐
#                     │                      │
#                ┌────▼──────────────────────▼─┐
#                │         Job 6              │
#                │    (Combine & Deploy)      │
#                └────────────────────────────┘
#
# Job 1 (rust-cpp-docs): Build Rust and C++ documentation
# Job 2 (screenshots-prereqs): Generate screenshots and extract version
# Job 3 (node-python-docs): Build Node and Python documentation
# Job 4 (astro-docs-tests): Build Astro docs and run tests (needs Job 2)
# Job 5 (check-warnings): Validate docs for warnings (needs Job 1)
# Job 6 (combine-deploy): Combine all artifacts and deploy (needs Jobs 1-4)
#
name: Build docs

on:
    workflow_call:
      secrets:
        READ_WRITE_PRIVATE_KEY:
          required: true
      inputs:
        release:
          type: string
          default: "false"
          required: false
          description: "Release? Enable options for building binaries for a release (i.e. apply a nightly tag, nightly version)"
        app-id:
          type: string
          required: true

jobs:
    # Job 1: Build Rust and C++ documentation
    rust-cpp-docs:
        runs-on: ubuntu-24.04
        env:
            # Allow deprecated warning because we are using nightly and some things might be deprecated in nightly
            # for which the stable alternative is not yet available.
            RUSTFLAGS: -D warnings -W deprecated
            RUSTDOCFLAGS: --html-in-header=/home/runner/work/slint/slint/docs/astro/src/utils/slint-docs-highlight.html -D warnings -W deprecated --cfg docsrs -Zunstable-options --generate-link-to-definition
            SLINT_NO_QT: 1
            CARGO_INCREMENTAL: false
            RELEASE_INPUT: ${{ inputs.release }}
        steps:
            - uses: actions/checkout@v5
            - uses: pnpm/action-setup@v4.2.0
              with:
                version: 10.18.2
            - name: Set up crate rustdoc link
              run: |
                  rgb_version=`grep 'rgb = '  internal/core/Cargo.toml | sed 's/^.*"\(.*\)"/\1/'`
                  echo "RUSTDOCFLAGS=$RUSTDOCFLAGS --extern-html-root-url rgb=https://docs.rs/rgb/$rgb_version/ --extern-html-root-url android_activity=https://docs.rs/android-activity/0.5/ --extern-html-root-url raw_window_handle=https://docs.rs/raw_window_handle/0.6 --extern-html-root-url winit=https://docs.rs/winit/0.30 --extern-html-root-url wgpu=https://docs.rs/wgpu/26 --extern-html-root-url input=https://docs.rs/input/0.9" >> $GITHUB_ENV
            - uses: actions/setup-node@v6
              with:
                node-version: 20
                package-manager-cache: false
            - uses: ./.github/actions/install-linux-dependencies
            - uses: ./.github/actions/setup-rust
              with:
                  toolchain: nightly
                  components: rustfmt
                  target: aarch64-linux-android
                  cache: false
            - name: Install apt dependencies
              run: sudo apt-get install doxygen
            - uses: baptiste0928/cargo-install@v3
              with:
                  crate: cargo-about
                  version: "=0.6.6"
            - name: Build Cpp docs
              run: |
                CPPDOCS_EXTRA_FLAGS=""
                if [ "$RELEASE_INPUT" != "true" ]; then
                    CPPDOCS_EXTRA_FLAGS="--experimental"
                fi
                cargo xtask cppdocs --show-warnings $CPPDOCS_EXTRA_FLAGS
            - name: "Rust docs"
              run: cargo doc -p slint -p slint-build -p slint-interpreter --no-deps --all-features
            - name: "Rust android-activity and i-slint-backend-winit"
              run: |
                  cargo doc -p i-slint-backend-android-activity -p i-slint-backend-winit -p i-slint-backend-testing --no-deps --target aarch64-linux-android --features=i-slint-backend-android-activity/native-activity,i-slint-backend-android-activity/aa-06,i-slint-backend-winit/raw-window-handle-06,i-slint-backend-winit/renderer-femtovg
                  cp -r target/aarch64-linux-android/doc/i_slint_backend_android_activity/ target/doc/
                  cp -r target/aarch64-linux-android/doc/i_slint_backend_winit/ target/doc/
                  cp -r target/aarch64-linux-android/doc/i_slint_backend_testing/ target/doc/
            - name: "Upload Rust/C++ Docs Artifacts"
              uses: actions/upload-artifact@v5
              with:
                  name: rust-cpp-docs
                  path: |
                      target/doc
                      target/cppdocs/html

    # Job 2: Generate screenshots and extract version info
    screenshots-prereqs:
        runs-on: ubuntu-24.04
        outputs:
            version: ${{ steps.version.outputs.VERSION }}
        env:
            RUSTFLAGS: -D warnings -W deprecated
            RUSTDOCFLAGS: --html-in-header=/home/runner/work/slint/slint/docs/astro/src/utils/slint-docs-highlight.html -D warnings -W deprecated --cfg docsrs -Zunstable-options --generate-link-to-definition
            SLINT_NO_QT: 1
            CARGO_INCREMENTAL: false
            RELEASE_INPUT: ${{ inputs.release }}
        steps:
            - uses: actions/checkout@v5
            - uses: pnpm/action-setup@v4.2.0
              with:
                version: 10.18.2
            - name: Set up crate rustdoc link
              run: |
                  rgb_version=`grep 'rgb = '  internal/core/Cargo.toml | sed 's/^.*"\(.*\)"/\1/'`
                  echo "RUSTDOCFLAGS=$RUSTDOCFLAGS --extern-html-root-url rgb=https://docs.rs/rgb/$rgb_version/ --extern-html-root-url android_activity=https://docs.rs/android-activity/0.5/ --extern-html-root-url raw_window_handle=https://docs.rs/raw_window_handle/0.6 --extern-html-root-url winit=https://docs.rs/winit/0.30 --extern-html-root-url wgpu=https://docs.rs/wgpu/26 --extern-html-root-url input=https://docs.rs/input/0.9" >> $GITHUB_ENV
            - uses: actions/setup-node@v6
              with:
                node-version: 20
                package-manager-cache: false
            - uses: ./.github/actions/install-linux-dependencies
            - name: Install MS fonts for comic sans needed by one of the screenshots in the docs
              run: |
                  echo ttf-mscorefonts-installer msttcorefonts/accepted-mscorefonts-eula select true | sudo debconf-set-selections
                  sudo apt-get install ttf-mscorefonts-installer -y
            - uses: ./.github/actions/setup-rust
              with:
                  toolchain: nightly
                  components: rustfmt
                  target: aarch64-linux-android
                  cache: false
            - name: Install apt dependencies
              run: sudo apt-get install doxygen
            - uses: baptiste0928/cargo-install@v3
              with:
                  crate: cargo-about
                  version: "=0.6.6"
            - name: "Generate Screenshots for Example Snippets"
              run: cargo run -p slint-docsnapper -- docs/astro/src/content --overwrite
            - name: Extract Version from Cargo.toml
              id: version
              run: |
                version=$(awk '/^\[workspace.package\]/ {found=1} found && /^version = / {gsub(/version = |"/, "", $0); print $0; exit}' Cargo.toml)
                if [[ -z "$version" ]]; then
                  echo "Version not found"
                  exit 1
                fi
                  echo "VERSION=$version" >> $GITHUB_OUTPUT
            - name: "Upload Screenshots and Version Artifacts"
              uses: actions/upload-artifact@v5
              with:
                  name: screenshots-version
                  path: |
                      docs/astro/src/content
                      docs/astro/src/assets/generated

    # Job 3: Build Node and Python documentation
    node-python-docs:
        runs-on: ubuntu-24.04
        env:
            RELEASE_INPUT: ${{ inputs.release }}
        steps:
            - uses: actions/checkout@v5
            - uses: pnpm/action-setup@v4.2.0
              with:
                version: 10.18.2
            - uses: actions/setup-node@v6
              with:
                node-version: 20
                package-manager-cache: false
            - uses: ./.github/actions/install-linux-dependencies
            - uses: ./.github/actions/setup-rust
              with:
                  toolchain: nightly
                  components: rustfmt
                  target: aarch64-linux-android
                  cache: false
            - uses: baptiste0928/cargo-install@v3
              with:
                  crate: cargo-about
                  version: "=0.6.6"
            - name: Install uv
              uses: astral-sh/setup-uv@v7
            - name: "Install Node dependencies"
              run: pnpm i --frozen-lockfile
            - name: "Node docs"
              run: pnpm run docs
              working-directory: api/node
            - name: Setup headless display
              uses: pyvista/setup-headless-display-action@v4
            - name: "Python docs"
              run: uv run build_docs.py
              working-directory: api/python/slint
            - name: "Upload Node/Python Docs Artifacts"
              uses: actions/upload-artifact@v5
              with:
                  name: node-python-docs
                  path: |
                      api/node/docs
                      api/python/slint/docs

    # Job 4: Build Astro docs and run tests (depends on screenshots-prereqs)
    astro-docs-tests:
        runs-on: ubuntu-24.04
        needs: screenshots-prereqs
        env:
            RUSTFLAGS: -D warnings -W deprecated
            RUSTDOCFLAGS: --html-in-header=/home/runner/work/slint/slint/docs/astro/src/utils/slint-docs-highlight.html -D warnings -W deprecated --cfg docsrs -Zunstable-options --generate-link-to-definition
            SLINT_NO_QT: 1
            CARGO_INCREMENTAL: false
            RELEASE_INPUT: ${{ inputs.release }}
        steps:
            - uses: actions/checkout@v5
            - uses: pnpm/action-setup@v4.2.0
              with:
                version: 10.18.2
            - uses: actions/setup-node@v6
              with:
                node-version: 20
                package-manager-cache: false
            - uses: ./.github/actions/install-linux-dependencies
            - uses: ./.github/actions/setup-rust
              with:
                  toolchain: nightly
                  components: rustfmt
                  target: aarch64-linux-android
                  cache: false
            - name: Download screenshots and version
              uses: actions/download-artifact@v5
              with:
                  name: screenshots-version
                  path: .
            - name: "Install Node dependencies"
              run: pnpm i --frozen-lockfile
            - name: Update URL for sitemap in site-config.ts
              run: |
                version="${{ needs.screenshots-prereqs.outputs.version }}"
                if [ "$RELEASE_INPUT" != "true" ]; then
                    base_url="https://snapshots.slint.dev"
                    base_path="/master/docs/slint/"
                    slint_download_version=nightly
                else
                    base_url="https://releases.slint.dev"
                    base_path="/$version/docs/slint/"
                    slint_download_version=v$version
                fi
                sed -i "s|BASE_URL = \".*\"|BASE_URL = \"$base_url\"|" docs/common/src/utils/site-config.ts
                sed -i "s|BASE_PATH = \".*\"|BASE_PATH = \"$base_path\"|" docs/common/src/utils/site-config.ts
                sed -i "s|SLINT_DOWNLOAD_VERSION = \".*\"| SLINT_DOWNLOAD_VERSION = \"$slint_download_version\"|" docs/common/src/utils/site-config.ts
            - name: "Slint Language Documentation"
              run: cargo xtask slintdocs
            - name: Spellcheck
              working-directory: docs/astro
              run: pnpm spellcheck
            - name: Install Playwright
              working-directory: docs/astro
              run: pnpm exec playwright install --with-deps
            - name: Run Playwright tests
              working-directory: docs/astro
              run: pnpm exec playwright test
            - name: Publish Test Summary Results
              working-directory: docs/astro
              run: npx github-actions-ctrf playwright-report/ctrf-report.json
            - name: Upload test results
              if: always()
              uses: actions/upload-artifact@v5
              with:
                name: playwright-test-report
                path: docs/astro/playwright-report/
                retention-days: 30
            - name: "Upload Astro Docs Artifacts"
              uses: actions/upload-artifact@v5
              with:
                  name: astro-docs
                  path: |
                      docs/astro/dist

    # Job 5: Check for docs warnings (depends on rust-cpp-docs)
    check-warnings:
        runs-on: ubuntu-24.04
        needs: rust-cpp-docs
        env:
            RUSTFLAGS: -D warnings -W deprecated
            SLINT_NO_QT: 1
            CARGO_INCREMENTAL: false
        steps:
            - uses: actions/checkout@v5
            - uses: pnpm/action-setup@v4.2.0
              with:
                version: 10.18.2
            - uses: actions/setup-node@v6
              with:
                node-version: 20
                package-manager-cache: false
            - uses: ./.github/actions/install-linux-dependencies
            - uses: ./.github/actions/setup-rust
              with:
                  toolchain: nightly
                  components: rustfmt
                  target: aarch64-linux-android
                  cache: false
            - name: "Check for docs warnings in internal crates"
              run: cargo doc --workspace --no-deps --all-features --exclude slint-node --exclude pyslint --exclude mcu-board-support --exclude mcu-embassy --exclude printerdemo_mcu --exclude carousel --exclude test-* --exclude plotter --exclude uefi-demo --exclude ffmpeg --exclude gstreamer-player --exclude slint-cpp --exclude slint-python

    # Job 6: Combine all artifacts and deploy (depends on all doc generation jobs)
    combine-deploy:
        runs-on: ubuntu-24.04
        needs: [rust-cpp-docs, screenshots-prereqs, node-python-docs, astro-docs-tests]
        steps:
            - uses: actions/checkout@v5
            - name: Download Rust/C++ docs
              uses: actions/download-artifact@v5
              with:
                  name: rust-cpp-docs
                  path: .
            - name: Download Node/Python docs
              uses: actions/download-artifact@v5
              with:
                  name: node-python-docs
                  path: .
            - name: Download Astro docs
              uses: actions/download-artifact@v5
              with:
                  name: astro-docs
                  path: docs/astro
            - name: Generate a token
              if: ${{ github.ref == 'refs/heads/master' }}
              id: app-token
              uses: actions/create-github-app-token@v2
              with:
                app-id: ${{ inputs.app-id }}
                private-key: ${{ secrets.READ_WRITE_PRIVATE_KEY }}
                repositories: website
            - name: Clone website directory
              if: ${{ github.ref == 'refs/heads/master' }}
              uses: actions/checkout@v5
              with:
                repository: slint-ui/website
                ref: prod
                path: website
                token: ${{ steps.app-token.outputs.token }}
                persist-credentials: false
            - name: Generate release-docs.html and 404.html
              if: ${{ github.ref == 'refs/heads/master' }}
              run: |
                mkdir -p website/output
                cd website && go run generator/generator.go -skip-agreements
            - name: Copy release-docs.html and 404.html
              if: ${{ github.ref == 'refs/heads/master' }}
              run: |
                mkdir -p docs/site
                cp website/output/release-docs.html docs/site/index.html
                cp website/output/404.html docs/site/404.html
                rm -rf website
            - name: "Upload Docs Artifacts"
              uses: actions/upload-artifact@v5
              with:
                  name: docs
                  path: |
                      target/doc
                      target/cppdocs/html
                      docs/astro/dist
                      api/node/docs
                      api/python/slint/docs
                      docs/site

