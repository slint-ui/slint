# Copyright Â© SixtyFPS GmbH <info@slint.dev>
# SPDX-License-Identifier: GPL-3.0-only OR LicenseRef-Slint-Royalty-free-2.0 OR LicenseRef-Slint-Software-3.0

name: Servo example

on:
  workflow_dispatch:
  workflow_call:
    secrets:
      ANDROID_KEYSTORE_BASE64:
        required: true
      ANDROID_KEYSTORE_PASSWORD:
        required: true

jobs:
  matrix_build:
    strategy:
      fail-fast: false
      matrix:
        # os: [ubuntu-latest, macos-latest]
        # removed ubuntu build for now as it failed cause related to yeslogic-fontconfig-sys and fontique dlopen feature conflict
        os: [macos-latest]
    runs-on: ${{ matrix.os }}
    steps:
      - uses: actions/checkout@v5
      - name: Cache build
        id: cache-build
        uses: actions/cache@v4
        with:
          path: examples/servo/target/release/servo_example
          key: cache-matrix-${{ matrix.os }}-build-${{ hashFiles('examples/servo/**') }}
      - name: Install uv
        if: steps.cache-build.outputs.cache-hit != 'true'
        uses: astral-sh/setup-uv@v7
      - name: Install rust
        if: steps.cache-build.outputs.cache-hit != 'true'
        uses: ./.github/actions/setup-rust
      - name: Install dependencies
        if: steps.cache-build.outputs.cache-hit != 'true'
        uses: ./.github/actions/install-linux-dependencies
      - name: Install skia dependencies
        if: steps.cache-build.outputs.cache-hit != 'true'
        uses: ./.github/actions/install-skia-dependencies
      - name: Build
        if: steps.cache-build.outputs.cache-hit != 'true'
        working-directory: examples/servo
        run: cargo build --release
  android_build:
    runs-on: macos-latest
    env:
      CARGO_PROFILE_RELEASE_OPT_LEVEL: s
      CARGO_INCREMENTAL: false
      CARGO_APK_RELEASE_KEYSTORE: /Users/runner/.android/release.keystore
      CARGO_APK_RELEASE_KEYSTORE_PASSWORD: ${{ secrets.ANDROID_KEYSTORE_PASSWORD }}
    steps:
      - uses: actions/checkout@v5
      - name: Cache build
        id: cache-android
        uses: actions/cache@v4
        with:
          path: examples/servo/target/release/apk/servo_example_lib.apk
          key: cache-android-build-${{ hashFiles('examples/servo/**') }}
      - name: Install uv
        if: steps.cache-android.outputs.cache-hit != 'true'
        uses: astral-sh/setup-uv@v7
      - name: Install rust
        if: steps.cache-android.outputs.cache-hit != 'true'
        uses: ./.github/actions/setup-rust
        with:
          target: aarch64-linux-android
      - name: Install dependencies
        if: steps.cache-android.outputs.cache-hit != 'true'
        uses: ./.github/actions/install-linux-dependencies
      - name: Install skia dependencies
        if: steps.cache-android.outputs.cache-hit != 'true'
        uses: ./.github/actions/install-skia-dependencies
      - name: Install API level
        if: steps.cache-android.outputs.cache-hit != 'true'
        run: ${ANDROID_HOME}/cmdline-tools/latest/bin/sdkmanager --install "platforms;android-30"
      - name: Install build-tools
        if: steps.cache-android.outputs.cache-hit != 'true'
        run: ${ANDROID_HOME}/cmdline-tools/latest/bin/sdkmanager --install "build-tools;34.0.0"
      - name: Install NDK
        if: steps.cache-android.outputs.cache-hit != 'true'
        run: ${ANDROID_HOME}/cmdline-tools/latest/bin/sdkmanager --install "ndk;28.2.13676358"
      - name: Install cargo-apk
        if: steps.cache-android.outputs.cache-hit != 'true'
        run: cargo install cargo-apk
      - name: Decode keystore
        if: steps.cache-android.outputs.cache-hit != 'true'
        run: |
          mkdir -p /Users/runner/.android
          echo "${{ secrets.ANDROID_KEYSTORE_BASE64 }}" | base64 --decode > $CARGO_APK_RELEASE_KEYSTORE
      - name: Build
        if: steps.cache-android.outputs.cache-hit != 'true'
        working-directory: examples/servo
        run: |
          export BINDGEN_EXTRA_CLANG_ARGS="--target=aarch64-linux-android30 --sysroot=$ANDROID_NDK_ROOT/toolchains/llvm/prebuilt/darwin-x86_64/sysroot"
          cargo apk build --target aarch64-linux-android --lib --release
