// Copyright Â© SixtyFPS GmbH <info@slint.dev>
// SPDX-License-Identifier: GPL-3.0-only OR LicenseRef-Slint-Royalty-free-2.0 OR LicenseRef-Slint-Software-3.0

import { Palette, ScrollView, LineEdit }  from "std-widgets.slint";

import { ExpandableGroup } from "../components/expandable-group.slint";

import { Api, ElementInformation, PropertyGroup, PropertyInformation } from "../api.slint";
import { EditorSpaceSettings, EditorFontSettings, EditorSizeSettings, ConsoleStyles, Icons } from "../components/styling.slint";
import { StringWidget } from "../components/widgets/string-widget.slint";
import { PropertyInformationWidget } from "../components/property-widgets.slint";
import { NameLabel } from "../components/widgets/basics.slint";

export component PropertyView inherits VerticalLayout {

    property <ElementInformation> element-information <=> Api.current-element;
    property <[PropertyGroup]> properties <=> Api.properties;
    in-out property <bool> properties-visible: false;

    property <length> key-width: self.width / 2.5;
    property <bool> element-loaded: root.properties.length > 0;
    in-out property <bool> enabled <=> sv.enabled;
    visible: root.properties-visible;
    header := Rectangle {
        height: ConsoleStyles.header-height;
        background: ConsoleStyles.header-background;
        Rectangle {
            y: 0;
            width: 100%;
            height: 1px;
            background: ConsoleStyles.divider-line;
            opacity: 50%;
        }

        Rectangle {
            y: parent.height - self.height;
            width: 100%;
            height: 1px;
            background: ConsoleStyles.divider-line;
        }

        HorizontalLayout {
            alignment: space-between;
            padding-left: EditorSpaceSettings.default-padding;
            padding-right: EditorSpaceSettings.default-padding;
            label := Text {
                horizontal-alignment: left;
                vertical-alignment: center;
                color: ConsoleStyles.text-color;
                font-family: "Inter";
                font-size: 12px;
                text: @tr("Properties");
            }

            Image {
                source: Icons.close;
                colorize: ita.has-hover ? Palette.foreground : Palette.foreground.transparentize(0.5);
                ita := TouchArea {
                    clicked => {
                        root.properties-visible = false;
                    }
                }
            }
        }
    }

    sv := ScrollView {
        vertical-scrollbar-policy: ScrollBarPolicy.always-on;
        horizontal-scrollbar-policy: ScrollBarPolicy.always-off;

        content-layer := VerticalLayout {

            if !root.element-loaded: Text {
                text: @tr("Select an Element");
                horizontal-alignment: center;
                vertical-alignment: center;
                vertical-stretch: 1;
            }
            if root.element-loaded: groups := VerticalLayout {
                alignment: start;
                spacing: EditorSpaceSettings.default-spacing;
                padding-top: EditorSpaceSettings.default-padding;
                VerticalLayout {
                padding: EditorSpaceSettings.default-padding;
                spacing: EditorSpaceSettings.default-spacing/4;
                Text {
                    text: "id";
                    font-size: 1rem;
                    font-weight: element-information.id != "" ? EditorFontSettings.regular-font-weight : EditorFontSettings.light-font-weight ;
                    font-italic: element-information.id != "" ? false : true;
                    opacity: element-information.id != "" ? 1.0 : 0.5;
                }
                    LineEdit {
                        enabled: sv.enabled;
                        property <string> id: element-information.id;
                        changed id => { self.text = id; }
                        text: id;
                        accepted(text) => {
                            Api.set-element-id(
                                element-information.source-uri,
                                element-information.source-version,
                                element-information.offset,
                                text,
                            );
                            self.text = id; // Resets so that when we reompile the element, we get it
                        }
                    }
                }
                for group in root.properties: VerticalLayout {

                    eg := ExpandableGroup {
                        property <[PropertyInformation]> properties: group.properties;

                        enabled: sv.enabled;

                        text: group.group-name;
                        panel-width: root.width;

                        VerticalLayout {
                            spacing: EditorSpaceSettings.property-spacing;
                            padding: EditorSpaceSettings.default-padding;

                            for property in eg.properties: PropertyInformationWidget {
                                enabled: sv.enabled;
                                element-information <=> root.element-information;
                                property-information: property;
                            }
                        }
                    }

                    VerticalLayout {

                        Rectangle {
                            height: EditorSpaceSettings.default-padding;
                        }

                        Rectangle {
                            height: 1px;
                            background: Palette.border;
                            width: 100%;
                        }
                    }
                }
            }
        }
    }
}
